<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Counting Laboratory - POWER-UP EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'JetBrains+Mono', monospace;
            overflow-x: hidden;
        }

        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .stat-card {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }

        .ai-msg { border-left: 4px solid #38bdf8; }
        .user-msg { border-left: 4px solid #fbbf24; }
        .fail-msg { border-left: 4px solid #f87171; background: rgba(127, 29, 29, 0.6); }
        .reaction-msg { border-left: 2px dashed #64748b; font-style: italic; font-size: 0.85rem; opacity: 0.8; }
        .achievement-msg { border-left: 4px solid #fbbf24; background: rgba(251, 191, 36, 0.15); font-weight: bold; color: #fbbf24; }
        .power-msg { border-left: 4px solid #a855f7; background: rgba(168, 85, 247, 0.1); font-weight: bold; color: #d8b4fe; }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10px { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            100% { transform: translate(0px, 0px) rotate(0deg); }
        }
        .screen-shake { animation: shake 0.2s; }

        .btn-control { transition: all 0.2s; text-transform: uppercase; font-size: 0.7rem; font-weight: bold; }
        
        .paused-overlay {
            position: absolute; inset: 0; background: rgba(15, 23, 42, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; backdrop-filter: blur(2px); pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        .paused .paused-overlay { opacity: 1; }
        
        #saveIndicator {
            position: fixed; bottom: 1rem; right: 1rem; font-size: 0.6rem;
            color: #64748b; pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
        .saving #saveIndicator { opacity: 1; }

        .power-btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
        
        .safety-active { border: 2px solid #22c55e !important; box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); }
    </style>
</head>
<body class="p-2 md:p-4">
    <div id="saveIndicator">SYNCING DATA...</div>
    <div class="max-w-[1600px] mx-auto">
        <header class="mb-4 text-center">
            <h1 class="text-3xl font-bold text-rose-500 mb-1 tracking-widest uppercase">Chaos Counting Lab</h1>
            <div class="flex justify-center gap-4 text-[10px] text-slate-500 font-bold">
                <span id="aiBoostStatus" class="text-slate-500">BOOST: OFF</span>
                <span>STAKES: SCALED</span>
                <span>AUTOSAVE: ACTIVE</span>
            </div>
        </header>

        <!-- Player Controls & Powers -->
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4">
            <!-- Systems -->
            <div class="stat-card p-3 rounded-lg flex flex-wrap items-center justify-between col-span-12 md:col-span-4 gap-2">
                <button id="pauseBtn" class="btn-control bg-amber-600 hover:bg-amber-500 text-white px-3 py-2 rounded flex-1">Pause AI</button>
                <button id="clearChatBtn" class="btn-control bg-sky-700 hover:bg-sky-600 text-white px-3 py-2 rounded flex-1">Clear Chat</button>
                <button id="resetBtn" class="btn-control bg-slate-700 hover:bg-rose-600 text-white px-3 py-2 rounded flex-1">Hard Reset</button>
            </div>
            
            <!-- Powers -->
            <div class="stat-card p-3 rounded-lg col-span-12 md:col-span-8 flex flex-wrap gap-2 items-center">
                <span class="text-[10px] text-slate-500 font-bold w-full md:w-auto mr-2">POWERS:</span>
                <button id="powerSafety" class="power-btn btn-control bg-green-700 hover:bg-green-600 text-white px-3 py-2 rounded flex-1">
                    Safety Net <span class="block text-[8px] opacity-70" id="cdSafety">Ready</span>
                </button>
                <button id="powerModel" class="power-btn btn-control bg-blue-700 hover:bg-blue-600 text-white px-3 py-2 rounded flex-1">
                    Model Up <span class="block text-[8px] opacity-70" id="cdModel">Ready</span>
                </button>
                <button id="powerXP" class="power-btn btn-control bg-purple-700 hover:bg-purple-600 text-white px-3 py-2 rounded flex-1">
                    5x XP <span class="block text-[8px] opacity-70" id="cdXP">Ready</span>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            <!-- Left Stats -->
            <div class="space-y-3">
                <div id="mainNumCard" class="stat-card p-3 rounded-lg border-rose-500/50">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Current Number</p>
                    <p id="currentNum" class="text-5xl font-black text-white">0</p>
                    <p id="safetyText" class="text-[9px] text-green-400 mt-1 hidden font-bold">SAFETY NET: <span id="safetyVal">0</span></p>
                </div>
                <div class="stat-card p-3 rounded-lg border-amber-500/50">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Your Personal Count</p>
                    <p id="playerBest" class="text-3xl font-black text-amber-400">0</p>
                </div>
                <div class="stat-card p-3 rounded-lg">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Peak Estimate</p>
                    <p id="peakEstimate" class="text-xl font-bold text-emerald-400">10</p>
                </div>
                <!-- Mini Charts Area -->
                <div class="stat-card p-2 rounded-lg h-40">
                    <canvas id="avgChart"></canvas>
                </div>
                <div class="stat-card p-2 rounded-lg h-40">
                    <canvas id="failChart"></canvas>
                </div>
            </div>

            <!-- Chat Area -->
            <div id="chatWrapper" class="lg:col-span-2 flex flex-col h-[70vh] bg-slate-900 rounded-xl border-2 border-slate-800 overflow-hidden shadow-2xl relative">
                <div class="paused-overlay text-amber-500 font-black text-2xl uppercase tracking-widest">AI Paused</div>
                <div id="chatBox" class="chat-container flex-1 overflow-y-auto p-4 space-y-2">
                    <div class="ai-msg p-2 bg-slate-800/50 rounded-r-lg">
                        <span class="text-sky-400 font-bold">SYSTEM:</span> Initializing Lab. Powers, Rivalry, and Charts online.
                    </div>
                </div>
                <div class="p-3 bg-slate-800 border-t border-slate-700">
                    <form id="chatForm" class="flex gap-2">
                        <input type="number" id="userInput" placeholder="HIT IT!" 
                               class="flex-1 bg-slate-950 border border-slate-700 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-rose-500 font-bold text-xl text-white">
                        <button type="submit" class="bg-rose-600 hover:bg-rose-500 text-white px-6 py-2 rounded font-black transition-all">
                            SEND
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-3">
                <!-- Leaderboard -->
                <div class="stat-card p-3 rounded-lg">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-2">Internal Leaderboard</p>
                    <div id="leaderboard" class="space-y-1 text-[11px]"></div>
                </div>
                
                <div class="stat-card p-3 rounded-lg border-amber-500/30">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Smartest AI</p>
                    <p id="smartestAi" class="text-xl font-bold text-emerald-400">Loading...</p>
                </div>
                
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 text-[9px] h-64 overflow-y-auto" id="levelDash">
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        let currentNumber = 0;
        let playerBest = 0;
        let isPaused = false;
        let safetyNetValue = null;
        let globalXPMultiplier = 1;
        
        let stats = {
            highest: 0,
            totalRuns: 0,
            sumOfFinals: 0,
            mistakes: Array(11).fill(0),
            peakEstimate: 10,
            avgHistory: [], // [avg, avg, avg]
            failLabels: ["AI 1", "AI 2", "AI 3", "AI 4", "AI 5", "AI 6", "AI 7", "AI 8", "AI 9", "AI 10"]
        };

        let cooldowns = {
            safety: 0,
            model: 0,
            xp: 0
        };

        let agents = [];
        const globalMilestones = [25, 50, 100, 250, 500, 1000, 2500, 5000];

        function initAgents() {
            agents = Array.from({ length: 10 }, (_, i) => ({
                id: i + 1,
                level: 1,
                xp: 0,
                name: `AI ${i + 1}`
            }));
        }

        // --- CHARTS ---
        let avgChart, failChart;
        function initCharts() {
            const avgCtx = document.getElementById('avgChart').getContext('2d');
            avgChart = new Chart(avgCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Score',
                        data: [],
                        borderColor: '#a855f7',
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: '#334155' } } } }
            });

            const failCtx = document.getElementById('failChart').getContext('2d');
            failChart = new Chart(failCtx, {
                type: 'bar',
                data: {
                    labels: stats.failLabels,
                    datasets: [{
                        label: 'Fails',
                        data: stats.mistakes.slice(1),
                        backgroundColor: '#f43f5e'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { font: { size: 8 } } }, y: { grid: { color: '#334155' } } } }
            });
        }

        // --- PERSISTENCE ---
        function saveData() {
            const data = {
                stats, agents, currentNumber, playerBest, cooldowns,
                timestamp: Date.now()
            };
            localStorage.setItem('chaos_lab_v2', JSON.stringify(data));
            document.body.classList.add('saving');
            setTimeout(() => document.body.classList.remove('saving'), 800);
        }

        function loadData() {
            const saved = localStorage.getItem('chaos_lab_v2');
            if (saved) {
                const data = JSON.parse(saved);
                stats = data.stats;
                agents = data.agents;
                currentNumber = data.currentNumber || 0;
                playerBest = data.playerBest || 0;
                cooldowns = data.cooldowns || cooldowns;
                
                // Redraw charts with loaded data
                avgChart.data.labels = stats.avgHistory.map((_, i) => i);
                avgChart.data.datasets[0].data = stats.avgHistory;
                avgChart.update();
                failChart.data.datasets[0].data = stats.mistakes.slice(1);
                failChart.update();
                return true;
            }
            return false;
        }

        // --- UTILS ---
        const getXpNeeded = (level) => level * 10;

        function updateUI() {
            document.getElementById('currentNum').innerText = currentNumber;
            document.getElementById('playerBest').innerText = playerBest;
            document.getElementById('peakEstimate').innerText = Math.round(stats.peakEstimate);
            
            // AI Rivalry Status
            const isBoosted = currentNumber > playerBest;
            const boostEl = document.getElementById('aiBoostStatus');
            boostEl.innerText = isBoosted ? "BOOST: 3X XP ACTIVE" : "BOOST: OFF";
            boostEl.className = isBoosted ? "text-emerald-400 animate-pulse font-black" : "text-slate-500 font-bold";

            // Leaderboard & Dash
            let smartest = agents[0];
            let dashHtml = "";
            let sorted = [...agents].sort((a, b) => (b.level * 100 + b.xp) - (a.level * 100 + a.xp));
            
            let leaderHtml = "";
            sorted.forEach((a, i) => {
                if (i === 0) smartest = a;
                leaderHtml += `<div class="flex justify-between"><span>#${i+1} ${a.name}</span> <span class="text-sky-400">Lv ${a.level}</span></div>`;
                dashHtml += `<div class="mb-1 border-b border-slate-700/50 pb-1">${a.name}: Lv ${a.level} [${a.xp}/${getXpNeeded(a.level)} XP]</div>`;
            });

            document.getElementById('leaderboard').innerHTML = leaderHtml;
            document.getElementById('levelDash').innerHTML = dashHtml;
            document.getElementById('smartestAi').innerText = `${smartest.name} (Lv ${smartest.level})`;

            // Cooldowns
            updateCooldownButton('powerSafety', 'cdSafety', cooldowns.safety);
            updateCooldownButton('powerModel', 'cdModel', cooldowns.model);
            updateCooldownButton('powerXP', 'cdXP', cooldowns.xp);
        }

        function updateCooldownButton(btnId, textId, cd) {
            const btn = document.getElementById(btnId);
            const txt = document.getElementById(textId);
            const now = Date.now();
            if (cd > now) {
                btn.disabled = true;
                const rem = Math.ceil((cd - now) / 1000);
                txt.innerText = `${Math.floor(rem/60)}m ${rem%60}s`;
            } else {
                btn.disabled = false;
                txt.innerText = "Ready";
            }
        }

        function addMessage(sender, text, type = 'ai', agent = null) {
            const div = document.createElement('div');
            let bgClass = 'ai-msg';
            let colorClass = 'text-sky-400';

            if(type === 'user') { bgClass = 'user-msg'; colorClass = 'text-amber-400'; }
            if(type === 'fail') { bgClass = 'fail-msg'; colorClass = 'text-rose-400'; }
            if(type === 'reaction') { bgClass = 'reaction-msg'; colorClass = 'text-slate-500'; }
            if(type === 'achievement') { bgClass = 'achievement-msg'; colorClass = 'text-amber-500'; }
            if(type === 'power') { bgClass = 'power-msg'; colorClass = 'text-purple-300'; }

            div.className = `${bgClass} p-2 bg-slate-800/30 rounded-r shadow-sm transition-all`;
            div.innerHTML = `<span class="${colorClass} font-bold">${sender}:</span> ${text}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            if(chatBox.children.length > 50) chatBox.removeChild(chatBox.firstChild);
        }

        // --- CORE LOGIC ---
        function handleFailure(culpritId) {
            document.body.classList.add('screen-shake');
            setTimeout(() => document.body.classList.remove('screen-shake'), 200);

            addMessage('SYSTEM', `FAILURE. Chain broken at ${currentNumber}.`, 'fail');
            
            stats.totalRuns++;
            stats.sumOfFinals += currentNumber;
            stats.mistakes[culpritId]++;
            
            // Add to Chart
            const newAvg = stats.sumOfFinals / stats.totalRuns;
            stats.avgHistory.push(parseFloat(newAvg.toFixed(2)));
            avgChart.data.labels.push(stats.totalRuns);
            avgChart.data.datasets[0].data.push(newAvg);
            avgChart.update();
            failChart.data.datasets[0].data = stats.mistakes.slice(1);
            failChart.update();

            if (culpritId > 0) {
                const a = agents[culpritId-1];
                const penalty = 5 + (a.level * 2);
                a.xp -= penalty;
                while(a.xp < 0 && a.level > 1) { a.level--; a.xp += getXpNeeded(a.level); }
                if(a.level === 1 && a.xp < 0) a.xp = 0;
            }

            // Safety Net Logic
            if (safetyNetValue !== null) {
                addMessage('SAFETY NET', `Shield triggered! Reverting to ${safetyNetValue} instead of 0.`, 'power');
                currentNumber = safetyNetValue;
            } else {
                currentNumber = 0;
            }

            updateUI();
            saveData();
        }

        function handleSuccess(newNum, agentId) {
            const wasBelow = currentNumber <= playerBest;
            currentNumber = newNum;
            const isNowAbove = currentNumber > playerBest;

            if (wasBelow && isNowAbove && playerBest > 0) {
                addMessage('SYSTEM', 'AI HAS SURPASSED PLAYER COUNT! 3x XP ENABLED!', 'achievement');
                agents.forEach(a => addMessage(a.name, "YES! WE ARE SUPERIOR!", "reaction"));
            }

            if(agentId > 0) {
                const a = agents[agentId-1];
                let xpGain = 1;
                
                // Apply Multipliers
                if (currentNumber > playerBest) xpGain *= 3;
                xpGain *= globalXPMultiplier;

                a.xp += xpGain;

                // Achievement logic
                if (newNum % 25 === 0) {
                    const bonus = Math.round(newNum * 0.1 * xpGain);
                    a.xp += bonus;
                    addMessage('ACHIEVEMENT', `${a.name} hit ${newNum}! Huge XP Bonus!`, 'achievement');
                }

                while(a.xp >= getXpNeeded(a.level)) {
                    a.xp -= getXpNeeded(a.level);
                    a.level++;
                }
            }

            if (currentNumber > stats.highest) {
                stats.highest = currentNumber;
                stats.peakEstimate = Math.max(stats.peakEstimate, currentNumber * 1.5);
            }
            updateUI();
        }

        function aiTurn() {
            if (isPaused) return;
            const agent = agents[Math.floor(Math.random() * 10)];
            const nextNum = currentNumber + 1;
            const failChance = Math.max(0.01, (nextNum / (15 + (agent.level * 20))) * 0.1);
            
            setTimeout(() => {
                if (isPaused || currentNumber + 1 !== nextNum) return;
                if (Math.random() < failChance) {
                    handleFailure(agent.id);
                } else {
                    handleSuccess(nextNum, agent.id);
                    addMessage(agent.name, nextNum, 'ai', agent);
                    if(Math.random() > 0.3) aiTurn();
                }
            }, 100 + Math.random() * 400);
        }

        // --- BUTTONS & INPUT ---
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const val = parseInt(userInput.value);
            if(isNaN(val)) return;
            const expected = currentNumber + 1;
            
            addMessage('YOU', val, 'user');
            if(val === expected) {
                if (val > playerBest) {
                    playerBest = val;
                    // If AI was above and we just caught them
                    if (currentNumber > playerBest - 1) {
                        addMessage('SYSTEM', 'PLAYER SURPASSED AI!', 'achievement');
                        agents.forEach(a => addMessage(a.name, "NOOO! Recalculating...", "reaction"));
                    }
                }
                handleSuccess(val, 0);
                if(!isPaused) aiTurn();
            } else {
                handleFailure(0);
            }
            userInput.value = '';
        });

        document.getElementById('powerSafety').addEventListener('click', () => {
            safetyNetValue = currentNumber;
            cooldowns.safety = Date.now() + (5 * 60 * 1000);
            document.getElementById('mainNumCard').classList.add('safety-active');
            document.getElementById('safetyText').classList.remove('hidden');
            document.getElementById('safetyVal').innerText = safetyNetValue;
            addMessage('POWER', `Safety Net deployed at ${safetyNetValue}! Valid for 2 minutes.`, 'power');
            
            setTimeout(() => {
                safetyNetValue = null;
                document.getElementById('mainNumCard').classList.remove('safety-active');
                document.getElementById('safetyText').classList.add('hidden');
                addMessage('SYSTEM', 'Safety Net has expired.', 'reaction');
            }, 2 * 60 * 1000);
            updateUI();
        });

        document.getElementById('powerModel').addEventListener('click', () => {
            agents.forEach(a => { a.level++; a.xp = 0; });
            cooldowns.model = Date.now() + (10 * 60 * 1000);
            addMessage('POWER', 'Global Model Improvement: All AIs +1 Level!', 'power');
            updateUI();
        });

        document.getElementById('powerXP').addEventListener('click', () => {
            globalXPMultiplier = 5;
            cooldowns.xp = Date.now() + (20 * 60 * 1000);
            addMessage('POWER', 'XP OVERLOAD: 5x Multiplier for 1 minute!', 'power');
            
            setTimeout(() => {
                globalXPMultiplier = 1;
                addMessage('SYSTEM', 'XP Multiplier returned to normal.', 'reaction');
            }, 60 * 1000);
            updateUI();
        });

        pauseBtn.addEventListener('click', () => {
            isPaused = !isPaused;
            pauseBtn.innerText = isPaused ? "Resume AI" : "Pause AI";
            chatWrapper.classList.toggle('paused');
        });

        clearChatBtn.addEventListener('click', () => {
            chatBox.innerHTML = '<div class="ai-msg p-2 bg-slate-800/50 rounded-r-lg"><span class="text-sky-400 font-bold">SYSTEM:</span> Chat buffer cleared.</div>';
        });

        resetBtn.addEventListener('click', () => {
            if(confirm("HARD RESET: This will wipe all AI levels, XP, and chart data. Continue?")) {
                localStorage.removeItem('chaos_lab_v2');
                location.reload();
            }
        });

        // --- INIT ---
        initAgents();
        initCharts();
        loadData();
        updateUI();
        setInterval(updateUI, 1000);
        setInterval(saveData, 10000);
        setInterval(() => { if(!isPaused && Math.random() > 0.4) aiTurn(); }, 1200);
    </script>
</body>
</html>
