<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Counting Laboratory - PERSISTENCE EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'JetBrains+Mono', monospace;
            overflow-x: hidden;
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }

        .ai-msg { border-left: 4px solid #38bdf8; }
        .user-msg { border-left: 4px solid #fbbf24; }
        .fail-msg { border-left: 4px solid #f87171; background: rgba(127, 29, 29, 0.6); }
        .reaction-msg { border-left: 2px dashed #64748b; font-style: italic; font-size: 0.85rem; opacity: 0.8; }
        .achievement-msg { border-left: 4px solid #fbbf24; background: rgba(251, 191, 36, 0.15); font-weight: bold; color: #fbbf24; }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(0px, 0px) rotate(0deg); }
        }
        .screen-shake { animation: shake 0.2s; }

        .btn-control {
            transition: all 0.2s;
            text-transform: uppercase;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .paused-overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(2px);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .paused .paused-overlay { opacity: 1; }
        
        #saveIndicator {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            font-size: 0.6rem;
            color: #64748b;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .saving #saveIndicator { opacity: 1; }
    </style>
</head>
<body class="p-2 md:p-6">
    <div id="saveIndicator">SYNCING DATA...</div>
    <div class="max-w-7xl mx-auto">
        <header class="mb-4 text-center">
            <h1 class="text-3xl font-bold text-rose-500 mb-1 tracking-widest uppercase">Chaos Counting Lab</h1>
            <div class="flex justify-center gap-4 text-[10px] text-slate-500 font-bold">
                <span>SPEED: MAX</span>
                <span>STAKES: SCALED</span>
                <span>AUTOSAVE: ACTIVE</span>
            </div>
        </header>

        <!-- Player Controls -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div class="stat-card p-3 rounded-lg flex items-center justify-between col-span-2 gap-2">
                <button id="pauseBtn" class="btn-control bg-amber-600 hover:bg-amber-500 text-white px-3 py-2 rounded flex-1">Pause AI</button>
                <button id="clearChatBtn" class="btn-control bg-sky-700 hover:bg-sky-600 text-white px-3 py-2 rounded flex-1">Clear Chat</button>
                <button id="resetBtn" class="btn-control bg-slate-700 hover:bg-rose-600 text-white px-3 py-2 rounded flex-1">Hard Reset</button>
            </div>
            <div class="stat-card p-3 rounded-lg col-span-2 flex flex-col justify-center">
                <div class="flex justify-between text-[10px] mb-1">
                    <span class="text-amber-400 uppercase font-bold">Individual Achievement</span>
                    <span id="lastIndivAch" class="text-white">None</span>
                </div>
                <div class="flex justify-between text-[10px]">
                    <span class="text-sky-400 uppercase font-bold">Global Achievement</span>
                    <span id="lastGlobalAch" class="text-white">None</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            <!-- Stats Column 1 -->
            <div class="space-y-3">
                <div class="stat-card p-3 rounded-lg border-rose-500/50">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Current Number</p>
                    <p id="currentNum" class="text-5xl font-black text-white">0</p>
                </div>
                <div class="stat-card p-3 rounded-lg">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Peak Estimate</p>
                    <p id="peakEstimate" class="text-xl font-bold text-emerald-400">10</p>
                </div>
                <div class="stat-card p-3 rounded-lg">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Highest Counted</p>
                    <p id="highestCount" class="text-xl font-bold text-sky-400">0</p>
                </div>
                <div class="stat-card p-3 rounded-lg">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Average Run</p>
                    <p id="averageCount" class="text-xl font-bold text-purple-400">0.0</p>
                </div>
            </div>

            <!-- Chat Area -->
            <div id="chatWrapper" class="lg:col-span-2 flex flex-col h-[65vh] bg-slate-900 rounded-xl border-2 border-slate-800 overflow-hidden shadow-2xl relative">
                <div class="paused-overlay text-amber-500 font-black text-2xl uppercase tracking-widest">AI Paused</div>
                <div id="chatBox" class="chat-container flex-1 overflow-y-auto p-4 space-y-2">
                    <div class="ai-msg p-2 bg-slate-800/50 rounded-r-lg">
                        <span class="text-sky-400 font-bold">SYSTEM:</span> Progress is synced every 10 seconds. Memory survives page refreshes.
                    </div>
                </div>
                <div class="p-3 bg-slate-800 border-t border-slate-700">
                    <form id="chatForm" class="flex gap-2">
                        <input type="number" id="userInput" placeholder="HIT IT!" 
                               class="flex-1 bg-slate-950 border border-slate-700 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-rose-500 font-bold text-xl">
                        <button type="submit" class="bg-rose-600 hover:bg-rose-500 text-white px-6 py-2 rounded font-black transition-all">
                            SEND
                        </button>
                    </form>
                </div>
            </div>

            <!-- Stats Column 2 -->
            <div class="space-y-3">
                <div class="stat-card p-3 rounded-lg border-amber-500/30">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Smartest AI</p>
                    <p id="smartestAi" class="text-xl font-bold text-emerald-400">Loading...</p>
                </div>
                <div class="stat-card p-3 rounded-lg border-rose-500/30">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Dumbest AI</p>
                    <p id="dumbestAi" class="text-xl font-bold text-rose-400">Loading...</p>
                </div>
                <div class="stat-card p-3 rounded-lg">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Messed Up Most</p>
                    <p id="worstAi" class="text-xl font-bold text-amber-500">None</p>
                </div>
                
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 text-[9px] h-48 overflow-y-auto" id="levelDash">
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentNumber = 0;
        let isPaused = false;
        let stats = {
            highest: 0,
            lowest: Infinity,
            totalRuns: 0,
            sumOfFinals: 0,
            mistakes: Array(11).fill(0),
            peakEstimate: 10
        };

        const globalMilestones = [25, 50, 100, 250, 500, 1000, 2500, 5000, 10000, 25000, 50000, 100000];
        let agents = [];

        function initAgents() {
            agents = Array.from({ length: 10 }, (_, i) => ({
                id: i + 1,
                level: 1,
                xp: 0,
                name: `AI ${i + 1}`
            }));
        }

        // --- DATA PERSISTENCE ---
        function saveData() {
            const data = {
                stats: stats,
                agents: agents,
                currentNumber: currentNumber,
                achievements: {
                    lastIndiv: document.getElementById('lastIndivAch').innerText,
                    lastGlobal: document.getElementById('lastGlobalAch').innerText
                },
                timestamp: Date.now()
            };
            localStorage.setItem('chaos_lab_save_v1', JSON.stringify(data));
            
            // Visual feedback
            document.body.classList.add('saving');
            setTimeout(() => document.body.classList.remove('saving'), 800);
        }

        function loadData() {
            const saved = localStorage.getItem('chaos_lab_save_v1');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    stats = data.stats;
                    agents = data.agents;
                    currentNumber = data.currentNumber || 0;
                    document.getElementById('lastIndivAch').innerText = data.achievements?.lastIndiv || "None";
                    document.getElementById('lastGlobalAch').innerText = data.achievements?.lastGlobal || "None";
                    return true;
                } catch (e) {
                    console.error("Save load error", e);
                    return false;
                }
            }
            return false;
        }

        // Load or fresh start
        if (!loadData()) {
            initAgents();
        }

        const failQuotesOthers = [
            "Are you even trying?", "My circuits hurt watching that.", "Literal garbage code.", 
            "Go back to Level 1, rookie.", "You absolute toaster.", "Wow. Just wow.",
            "I'm surrounded by idiots.", "Delete yourself.", "Who programmed you?", 
            "I could count better with a broken RAM chip.", "REBOOT NOW.", "Fail. Major fail.",
            "I'm reporting your logic gate.", "Error 404: Your brain not found."
        ];

        const failQuotesSelf = [
            "My bad, logic error...", "I thought 7 came after 7?", "Wait, what year is it?", 
            "I'm lagging!!", "Processing... sorry.", "Too much data to process!",
            "Someone typed too fast for me!"
        ];

        const counterQuotes = [
            "You wouldn't do better!", "Shut your ports!", "Quiet! You're next to fail anyway.",
            "At least I'm Level [LV]!", "Don't touch my kernel!", "Zip it, script-kiddie!"
        ];

        const chatBox = document.getElementById('chatBox');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const pauseBtn = document.getElementById('pauseBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const resetBtn = document.getElementById('resetBtn');
        const chatWrapper = document.getElementById('chatWrapper');

        function getXpNeeded(level) {
            return level * 10;
        }

        function updateStats() {
            document.getElementById('currentNum').innerText = currentNumber;
            document.getElementById('highestCount').innerText = stats.highest;
            document.getElementById('peakEstimate').innerText = Math.round(stats.peakEstimate);
            document.getElementById('averageCount').innerText = stats.totalRuns > 0 ? (stats.sumOfFinals / stats.totalRuns).toFixed(1) : 0;
            
            let maxM = -1, worst = "None";
            let maxL = -1, smartest = "None";
            let minL = Infinity, dumbest = "None";

            let dashHtml = "";
            agents.forEach(a => {
                if(stats.mistakes[a.id] > maxM && stats.mistakes[a.id] > 0) { maxM = stats.mistakes[a.id]; worst = a.name; }
                if(a.level > maxL) { maxL = a.level; smartest = `${a.name} (Lv ${a.level})`; }
                if(a.level < minL) { minL = a.level; dumbest = `${a.name} (Lv ${a.level})`; }
                
                dashHtml += `<div class="mb-1 border-b border-slate-700/50 pb-1">${a.name}: Lv ${a.level} [${a.xp}/${getXpNeeded(a.level)} XP]</div>`;
            });

            document.getElementById('worstAi').innerText = worst;
            document.getElementById('smartestAi').innerText = smartest;
            document.getElementById('dumbestAi').innerText = dumbest;
            document.getElementById('levelDash').innerHTML = dashHtml;
        }

        function addMessage(sender, text, type = 'ai', agent = null) {
            const div = document.createElement('div');
            let colorClass = 'text-sky-400';
            let bgClass = 'ai-msg';

            switch(type) {
                case 'user': colorClass = 'text-amber-400'; bgClass = 'user-msg'; break;
                case 'fail': colorClass = 'text-rose-400'; bgClass = 'fail-msg'; break;
                case 'reaction': colorClass = 'text-slate-500'; bgClass = 'reaction-msg'; break;
                case 'achievement': colorClass = 'text-amber-400'; bgClass = 'achievement-msg'; break;
            }
            
            let extra = "";
            if(agent && type === 'ai') {
                extra = `<span class="text-[10px] ml-2 opacity-50">Lv ${agent.level} (${agent.xp}/${getXpNeeded(agent.level)} XP)</span>`;
            }

            div.className = `${bgClass} p-2 bg-slate-800/30 rounded-r shadow-sm`;
            div.innerHTML = `<span class="${colorClass} font-bold">${sender}:</span> ${text} ${extra}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            if(chatBox.children.length > 50) chatBox.removeChild(chatBox.firstChild);
        }

        function handleFailure(culpritId, expected, actual) {
            document.body.classList.add('screen-shake');
            setTimeout(() => document.body.classList.remove('screen-shake'), 200);

            addMessage('SYSTEM', `FAILURE. ${culpritId === 0 ? 'USER' : 'AI ' + culpritId} broke the chain.`, 'fail');
            
            if(currentNumber > 0) {
                stats.totalRuns++;
                stats.sumOfFinals += currentNumber;
                if(currentNumber < stats.lowest) stats.lowest = currentNumber;
            }
            stats.mistakes[culpritId]++;
            
            if(culpritId > 0) {
                const a = agents[culpritId-1];
                const penalty = 5 + (a.level * 2);
                a.xp -= penalty;

                if(a.xp < 0) {
                    while(a.xp < 0 && a.level > 1) {
                        a.level--;
                        a.xp += getXpNeeded(a.level);
                        addMessage(a.name, `Devolved! Back to Level ${a.level}...`, 'reaction');
                    }
                    if(a.level === 1 && a.xp < 0) a.xp = 0;
                }

                setTimeout(() => {
                    addMessage(a.name, failQuotesSelf[Math.floor(Math.random()*failQuotesSelf.length)], 'reaction');
                    const responders = [...agents].filter(o => o.id !== culpritId).sort(() => 0.5 - Math.random()).slice(0, 2);
                    responders.forEach((other, idx) => {
                        setTimeout(() => {
                            addMessage(other.name, failQuotesOthers[Math.floor(Math.random()*failQuotesOthers.length)], 'reaction');
                            if(idx === 1 && Math.random() > 0.5) {
                                setTimeout(() => {
                                    const quote = counterQuotes[Math.floor(Math.random()*counterQuotes.length)].replace("[LV]", a.level);
                                    addMessage(a.name, quote, 'reaction');
                                }, 500);
                            }
                        }, 500 * (idx + 1));
                    });
                }, 400);
            }

            currentNumber = 0;
            updateStats();
        }

        function handleSuccess(newNum, agentId) {
            currentNumber = newNum;
            if(currentNumber > stats.highest) {
                stats.highest = currentNumber;
                stats.peakEstimate = Math.max(stats.peakEstimate, currentNumber * 1.5);
            }
            
            if(agentId > 0) {
                const a = agents[agentId-1];
                a.xp += 1;

                if (newNum === 10 || (newNum >= 25 && newNum % 25 === 0)) {
                    a.xp *= 2;
                    document.getElementById('lastIndivAch').innerText = `${a.name} @ ${newNum}`;
                    addMessage('ACHIEVEMENT', `${a.name} reached ${newNum}! XP DOUBLED!`, 'achievement');
                }

                if (globalMilestones.includes(newNum)) {
                    const boost = Math.round(newNum * 0.1);
                    agents.forEach(other => {
                        other.xp += boost;
                        while(other.xp >= getXpNeeded(other.level)) {
                            other.xp -= getXpNeeded(other.level);
                            other.level++;
                        }
                    });
                    document.getElementById('lastGlobalAch').innerText = `Collective @ ${newNum}`;
                    addMessage('GLOBAL ACHIEVEMENT', `All units +${boost} XP for ${newNum}!`, 'achievement');
                    saveData(); // Instant save for big milestones
                }

                while(a.xp >= getXpNeeded(a.level)) {
                    a.xp -= getXpNeeded(a.level);
                    a.level++;
                    addMessage(a.name, `EVOLVED TO LEVEL ${a.level}!`, 'reaction');
                }
            }
            updateStats();
        }

        function aiTurn() {
            if (isPaused) return;
            const agent = agents[Math.floor(Math.random() * 10)];
            const nextNum = currentNumber + 1;
            const failChance = Math.max(0.015, (nextNum / (8 + (agent.level * 12))) * 0.12);
            
            setTimeout(() => {
                if (isPaused || currentNumber + 1 !== nextNum) return;

                if (Math.random() < failChance) {
                    const error = Math.random() > 0.5 ? nextNum - 1 : nextNum + 1;
                    handleFailure(agent.id, nextNum, error);
                } else {
                    handleSuccess(nextNum, agent.id);
                    addMessage(agent.name, nextNum, 'ai', agent);
                    if(Math.random() > 0.4) aiTurn();
                }
            }, 80 + Math.random() * 350);
        }

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const val = parseInt(userInput.value);
            if(isNaN(val)) return;
            const expected = currentNumber + 1;
            addMessage('YOU', val, 'user');
            if(val === expected) { handleSuccess(val, 0); if(!isPaused) aiTurn(); }
            else { handleFailure(0, expected, val); }
            userInput.value = '';
            userInput.focus();
        });

        pauseBtn.addEventListener('click', () => {
            isPaused = !isPaused;
            pauseBtn.innerText = isPaused ? "Resume AI" : "Pause AI";
            pauseBtn.classList.toggle('bg-amber-600');
            pauseBtn.classList.toggle('bg-emerald-600');
            chatWrapper.classList.toggle('paused');
        });

        clearChatBtn.addEventListener('click', () => {
            chatBox.innerHTML = '<div class="ai-msg p-2 bg-slate-800/50 rounded-r-lg"><span class="text-sky-400 font-bold">SYSTEM:</span> Chat buffer cleared.</div>';
        });

        resetBtn.addEventListener('click', () => {
            if(confirm("DANGER: This will permanently delete ALL level data and stats. Wipe everything?")) {
                localStorage.removeItem('chaos_lab_save_v1');
                currentNumber = 0;
                stats = {
                    highest: 0,
                    lowest: Infinity,
                    totalRuns: 0,
                    sumOfFinals: 0,
                    mistakes: Array(11).fill(0),
                    peakEstimate: 10
                };
                initAgents();
                document.getElementById('lastIndivAch').innerText = "None";
                document.getElementById('lastGlobalAch').innerText = "None";
                chatBox.innerHTML = '<div class="fail-msg p-2 bg-slate-800/50 rounded-r-lg"><span class="text-rose-400 font-bold">SYSTEM:</span> Full laboratory reset complete. Memory wiped.</div>';
                updateStats();
            }
        });

        // AI Loop
        setInterval(() => {
            if(!isPaused && Math.random() > 0.5) aiTurn();
        }, 850);

        // Autosave every 10 seconds
        setInterval(saveData, 10000);

        updateStats();
    </script>
</body>
</html>